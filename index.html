<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∏–∫–∞–∑–æ–≤</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 950px; margin: 40px auto; padding: 0 20px; background: #f5f5f5; }
  h1 { color: #2c3e50; }
  .form-block { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
  label { display: block; font-weight: bold; margin: 10px 0 3px; color: #34495e; }
  input, select { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
  .input-with-hint { position: relative; }
  .hint-list { position: absolute; z-index: 100; background: white; border: 1px solid #ccc; border-radius: 4px; width: 100%; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
  .hint-item { padding: 8px 12px; cursor: pointer; font-size: 14px; }
  .hint-item:hover { background: #e8f4fd; }
  .person-block { border: 1px solid #d0e4f0; border-radius: 6px; padding: 14px 16px; margin-top: 12px; background: #f0f7fc; position: relative; }
  .person-title { font-weight: bold; color: #1a5276; margin-bottom: 6px; font-size: 13px; }
  .remove-btn { position: absolute; top: 10px; right: 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 3px 10px; cursor: pointer; font-size: 13px; }
  .remove-btn:hover { background: #c0392b; }
  .add-btn { margin-top: 12px; padding: 8px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
  .add-btn:hover { background: #1e8449; }
  .gen-btn { margin-top: 16px; padding: 10px 28px; background: #2980b9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 15px; }
  .gen-btn:hover { background: #1a6fa3; }
  .genitive-preview { font-size: 12px; color: #7f8c8d; margin-top: 2px; min-height: 16px; }
  .genitive-preview span { color: #27ae60; font-style: italic; }
  #preview {
    background: white; padding: 60px 70px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    font-family: "Times New Roman", serif; font-size: 12pt;
    line-height: 1; display: none;
  }
  #preview p, #preview div { margin: 0; padding: 0; line-height: 1; }
  .pr-center  { text-align: center; }
  .pr-bold    { font-weight: bold; }
  .pr-justify { text-align: justify; }
  .pr-gap     { height: 12pt; display: block; }
  .pr-header-table { width: 100%; border-collapse: collapse; }
  .pr-header-table td { border: none; padding: 0; font-size: 12pt; line-height: 1.3; }
  .pr-sign-table { width: 100%; border-collapse: collapse; }
  .pr-sign-table td { border: none; padding: 0; font-weight: bold; font-size: 12pt; line-height: 1; }
  .pr-annex-table { width: 100%; border-collapse: collapse; }
  .pr-annex-table th { border: 1px solid #000; padding: 4px 6px; text-align: center; font-size: 12pt; font-weight: bold; background: #f0f0f0; }
  .pr-annex-table td { border: 1px solid #000; padding: 4px 6px; font-size: 12pt; text-align: left; }
  .pr-annex-table td:first-child { text-align: center; }
  .page-break-label { border-top: 3px dashed #aaa; margin: 24px 0 16px; text-align: center; color: #aaa; font-size: 11px; }
  .btn-row { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
  .btn-docx { background: #1a5276; color: white; border: none; border-radius: 4px; padding: 10px 24px; cursor: pointer; font-size: 15px; }
  .btn-docx:hover { background: #154360; }
  .btn-copy { background: #27ae60; color: white; border: none; border-radius: 4px; padding: 10px 24px; cursor: pointer; font-size: 15px; }
  .btn-copy:hover { background: #1e8449; }
  .status { padding: 8px 14px; border-radius: 4px; margin-top: 10px; font-size: 13px; display: none; }
  .status.ok  { background: #d4edda; color: #155724; display: block; }
  .status.err { background: #f8d7da; color: #721c24; display: block; }
  .info-badge { background: #d6eaf8; color: #1a5276; border-radius: 4px; padding: 8px 14px; font-size: 13px; margin-bottom: 12px; }
  .saved-tag  { font-size: 11px; color: #27ae60; margin-left: 6px; }
</style>
</head>
<body>

<h1>üìÑ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∏–∫–∞–∑–æ–≤</h1>

<div class="form-block">
  <label>–¢–∏–ø –ø—Ä–∏–∫–∞–∑–∞:</label>
  <select id="templateSelect" onchange="renderFields()">
    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏–∫–∞–∑–∞ ‚Äî</option>
    <option value="tosi">–ü—Ä–∏–∫–∞–∑ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –¢–û –°–ò</option>
    <option value="bosi">–ü—Ä–∏–∫–∞–∑ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –ë–û –°–ò</option>
  </select>
  <div id="baseFields"></div>
  <div id="personsBlock"></div>
  <div id="addBtnWrap" style="display:none">
    <button class="add-btn" onclick="addPerson()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</button>
  </div>
  <br>
  <button class="gen-btn" onclick="generateDoc()">‚ñ∂ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
</div>

<div id="statusMsg" class="status"></div>
<div id="preview"></div>
<div class="btn-row" id="btnRow" style="display:none">
  <button class="btn-docx" onclick="downloadDocx()">üìÑ –°–∫–∞—á–∞—Ç—å .docx (Word)</button>
  <button class="btn-copy" onclick="copyDoc()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/petrovich/petrovich.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>

const DIRECTOR      = "–ï–º–µ–ª—å—è–Ω–µ–Ω–∫–æ –ú–∞–∫—Å–∏–º –°–µ—Ä–≥–µ–µ–≤–∏—á";
const DIRECTOR_POST = "–î–∏—Ä–µ–∫—Ç–æ—Ä –û–û–û ¬´–°–¢–î–í¬ª";
const FONT = "Times New Roman";
const SZ   = 24;
const SZ_S = 24;
const MONTHS = ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è",
                "–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"];
const STORAGE_CONTRACTS = "prikaz_contracts";
const STORAGE_OBJECTS   = "prikaz_objects";
const STORAGE_SHEETS    = "prikaz_sheets_url";

// =============================================
//  –í–®–ò–¢–´–ô URL ‚Äî –º–µ–Ω—è—Ç—å –∑–¥–µ—Å—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
// =============================================
const SHEETS_URL_DEFAULT = "https://script.google.com/macros/s/AKfycbxY4tc95PzxzfALM8FZ6WQlyMtGBpkdjOgozMCvG-QBj-Tk-V8X3S-YEmgGJfcsQW8I/exec";

// =============================================
//  localStorage
// =============================================
function getSaved(key){ try{return JSON.parse(localStorage.getItem(key))||[];}catch(e){return[];} }
function addSaved(key,value){
  if(!value) return;
  let arr=getSaved(key);
  if(!arr.includes(value)){arr.unshift(value);if(arr.length>20)arr=arr.slice(0,20);}
  localStorage.setItem(key,JSON.stringify(arr));
}
function getSheetsUrl(){ return SHEETS_URL_DEFAULT; }

// =============================================
//  –ü–û–î–°–ö–ê–ó–ö–ò
// =============================================
function showHints(inputId,storageKey){
  hideHints(inputId);
  const inp=document.getElementById(inputId);
  const val=inp.value.toLowerCase();
  const all=getSaved(storageKey).filter(v=>v.toLowerCase().includes(val));
  if(!all.length) return;
  const list=document.createElement("div");
  list.className="hint-list"; list.id="hint_"+inputId;
  all.forEach(v=>{
    const item=document.createElement("div");
    item.className="hint-item"; item.textContent=v;
    item.onmousedown=()=>{inp.value=v;hideHints(inputId);};
    list.appendChild(item);
  });
  inp.parentNode.style.position="relative";
  inp.parentNode.appendChild(list);
}
function hideHints(inputId){const el=document.getElementById("hint_"+inputId);if(el)el.remove();}

// =============================================
//  –°–ö–õ–û–ù–ï–ù–ò–ï –§–ò–û
// =============================================
function declineFullName(fullName){
  if(typeof petrovich==="undefined") return fullName;
  const parts=fullName.trim().split(/\s+/);
  if(parts.length<2) return fullName;
  try{
    const last=parts[0]||"",first=parts[1]||"",middle=parts[2]||"";
    const gender=middle.endsWith("–Ω–∞")?"female":"male";
    let r="";
    if(last)   r+=(petrovich[gender].last.genitive   ?petrovich[gender].last.genitive(last)    :last)+" ";
    if(first)  r+=(petrovich[gender].first.genitive  ?petrovich[gender].first.genitive(first)  :first)+" ";
    if(middle) r+=(petrovich[gender].middle.genitive ?petrovich[gender].middle.genitive(middle):middle);
    return r.trim()||fullName;
  }catch(e){return fullName;}
}

function updateGenitivePreview(idx){
  const fioEl=document.getElementById(`p_fio_${idx}`);
  const pEl  =document.getElementById(`p_gen_${idx}`);
  if(!fioEl||!pEl) return;
  const fio=fioEl.value.trim();
  if(!fio){pEl.innerHTML="";return;}
  pEl.innerHTML=`–†–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂: <span>${declineFullName(fio)}</span>`;
}

// =============================================
//  –®–ê–ë–õ–û–ù–´
// =============================================
const templates={
  tosi:{
    name:"–ü—Ä–∏–∫–∞–∑ –¢–û –°–ò",
    baseFields:[
      {id:"num",     label:"–ù–æ–º–µ—Ä –ø—Ä–∏–∫–∞–∑–∞",   hint:"–ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"},
      {id:"date",    label:"–î–∞—Ç–∞ –ø—Ä–∏–∫–∞–∑–∞",    type:"date"},
      {id:"contract",label:"–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞",  storage:STORAGE_CONTRACTS},
      {id:"object",  label:"–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞",storage:STORAGE_OBJECTS},
    ],
    subject: (f)=>`–û –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞ –∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π (–¢–û –°–ò) –Ω–∞ –æ–±—ä–µ–∫—Ç–µ ¬´${f.object}¬ª`,
    preamble:(f)=>`–í —Ü–µ–ª—è—Ö –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥–ª–µ–∂–∞—â–µ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ –æ—Ç 26.06.2008 ‚Ññ 102-–§–ó ¬´–û–± –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–∏ –µ–¥–∏–Ω—Å—Ç–≤–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–π¬ª, –∞ —Ç–∞–∫–∂–µ –≤–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –î–æ–≥–æ–≤–æ—Ä–∞ ‚Ññ ${f.contract},`,
    points:(f,persons)=>[
      `–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –ª–∏—Ü–æ–º –∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π (–¢–û –°–ò) –Ω–∞ –æ–±—ä–µ–∫—Ç–µ ¬´${f.object}¬ª: ${persons.map(p=>`${p.position} ‚Äî ${p.fioGen}`).join("; ")}.`,
      `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ª–∏—Ü—É –≤ —Å–≤–æ–µ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ ‚Ññ 102-–§–ó, –º–µ–∂–ø–æ–≤–µ—Ä–æ—á–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è–º–∏ –°–ò, –∞ —Ç–∞–∫–∂–µ —É—Å–ª–æ–≤–∏—è–º–∏ –î–æ–≥–æ–≤–æ—Ä–∞ ‚Ññ ${f.contract}.`,
      `–û–±–µ—Å–ø–µ—á–∏—Ç—å —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–≤–µ—Ä–∫–∏, –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∏ —Ä–µ–º–æ–Ω—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π, –∞ —Ç–∞–∫–∂–µ –≤–µ–¥–µ–Ω–∏–µ —É—á—ë—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –°–ò.`,
      `–ö–æ–Ω—Ç—Ä–æ–ª—å –∑–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –ø—Ä–∏–∫–∞–∑–∞ –æ—Å—Ç–∞–≤–ª—è—é –∑–∞ —Å–æ–±–æ–π.`,
    ],
    annexRef:(f)=>`–∫ –ü—Ä–∏–∫–∞–∑—É ‚Ññ ${f.num} –æ—Ç ${fmtLong(f.date)}`,
  },
  bosi:{
    name:"–ü—Ä–∏–∫–∞–∑ –ë–û –°–ò",
    baseFields:[
      {id:"num",     label:"–ù–æ–º–µ—Ä –ø—Ä–∏–∫–∞–∑–∞",   hint:"–ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"},
      {id:"date",    label:"–î–∞—Ç–∞ –ø—Ä–∏–∫–∞–∑–∞",    type:"date"},
      {id:"contract",label:"–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞",  storage:STORAGE_CONTRACTS},
      {id:"object",  label:"–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞",storage:STORAGE_OBJECTS},
    ],
    subject: (f)=>`–û –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞ –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π (–ë–û –°–ò) –Ω–∞ –æ–±—ä–µ–∫—Ç–µ ¬´${f.object}¬ª`,
    preamble:(f)=>`–í —Ü–µ–ª—è—Ö –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ ¬´${f.object}¬ª, –∞ —Ç–∞–∫–∂–µ –≤–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –î–æ–≥–æ–≤–æ—Ä–∞ ‚Ññ ${f.contract},`,
    points:(f,persons)=>[
      `–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –ª–∏—Ü–æ–º –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑–º–µ—Ä–µ–Ω–∏–π (–ë–û –°–ò) –Ω–∞ –æ–±—ä–µ–∫—Ç–µ ¬´${f.object}¬ª: ${persons.map(p=>`${p.position} ‚Äî ${p.fioGen}`).join("; ")}.`,
      `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ª–∏—Ü—É –æ–±–µ—Å–ø–µ—á–∏—Ç—å: —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –°–ò; –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∞, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å –°–ò; –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—ã–≤–µ–¥–µ–Ω–∏–µ –∏–∑ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω—ã—Ö –°–ò; –≤–µ–¥–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ —É—á—ë—Ç–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –°–ò.`,
      `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ª–∏—Ü—É —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è —É—Å–ª–æ–≤–∏—è–º–∏ –î–æ–≥–æ–≤–æ—Ä–∞ ‚Ññ ${f.contract} –∏ –¥–µ–π—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –º–µ—Ç—Ä–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.`,
      `–ö–æ–Ω—Ç—Ä–æ–ª—å –∑–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –ø—Ä–∏–∫–∞–∑–∞ –æ—Å—Ç–∞–≤–ª—è—é –∑–∞ —Å–æ–±–æ–π.`,
    ],
    annexRef:(f)=>`–∫ –ü—Ä–∏–∫–∞–∑—É ‚Ññ ${f.num} –æ—Ç ${fmtLong(f.date)}`,
  },
};

// =============================================
//  –£–¢–ò–õ–ò–¢–´
// =============================================
function fmtLong(d){
  if(!d) return "___";
  const [y,m,dd]=d.split("-");
  return `${parseInt(dd)} ${MONTHS[parseInt(m)-1]} ${y} –≥.`;
}
function esc(s){
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;")
                  .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function showStatus(msg,isErr){
  const el=document.getElementById("statusMsg");
  el.className="status "+(isErr?"err":"ok");
  el.textContent=msg;
  setTimeout(()=>el.style.display="none",6000);
}

// =============================================
//  –§–û–†–ú–ê
// =============================================
let personCount=0;

function renderFields(){
  const key=document.getElementById("templateSelect").value;
  ["baseFields","personsBlock"].forEach(id=>document.getElementById(id).innerHTML="");
  document.getElementById("addBtnWrap").style.display="none";
  document.getElementById("preview").style.display="none";
  document.getElementById("btnRow").style.display="none";
  personCount=0;
  if(!key) return;
  const bf=document.getElementById("baseFields");

  bf.innerHTML+=`<div class="info-badge">üî¢ –ù–æ–º–µ—Ä –ø—Ä–∏–∫–∞–∑–∞ –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ Google Sheets</div>
    <input type="hidden" id="field_num" value="auto">`;

  templates[key].baseFields.filter(f=>f.id!=="num").forEach(f=>{
    const saved=f.storage?getSaved(f.storage):[];
    const mark=saved.length?`<span class="saved-tag">üíæ ${saved.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>`:"";
    bf.innerHTML+=`<label>${f.label}: ${mark}</label>
      <div class="input-with-hint">
        <input type="${f.type||'text'}" id="field_${f.id}" placeholder="${f.hint||f.label}"
          ${f.storage?`oninput="showHints('field_${f.id}','${f.storage}')" onfocus="showHints('field_${f.id}','${f.storage}')" onblur="setTimeout(()=>hideHints('field_${f.id}'),200)"`:""}
        >
      </div>`;
  });
  document.getElementById("addBtnWrap").style.display="block";
  addPerson();
}

function addPerson(){
  personCount++;
  const idx=personCount;
  const d=document.createElement("div");
  d.className="person-block"; d.id=`person_${idx}`;
  d.innerHTML=`<div class="person-title">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Ññ ${idx}</div>
    ${idx>1?`<button class="remove-btn" onclick="removePerson(${idx})">‚úï –£–¥–∞–ª–∏—Ç—å</button>`:""}
    <label>–§–ò–û (–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂):</label>
    <input type="text" id="p_fio_${idx}" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
      oninput="updateGenitivePreview(${idx})">
    <div class="genitive-preview" id="p_gen_${idx}"></div>
    <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
    <input type="text" id="p_pos_${idx}" placeholder="–í–µ–¥—É—â–∏–π –∏–Ω–∂–µ–Ω–µ—Ä –ü–¢–û">`;
  document.getElementById("personsBlock").appendChild(d);
}

function removePerson(idx){const el=document.getElementById(`person_${idx}`);if(el)el.remove();}

function getBase(key){
  const v={num:"auto"}; let ok=true;
  templates[key].baseFields.filter(f=>f.id!=="num").forEach(f=>{
    const el=document.getElementById("field_"+f.id);
    v[f.id]=el?el.value.trim():"";
    if(!v[f.id]){if(el)el.style.border="1.5px solid red";ok=false;}
    else if(el) el.style.border="1px solid #ccc";
  });
  return ok?v:null;
}

function getPersons(){
  const list=[];
  for(let i=1;i<=personCount;i++){
    const fe=document.getElementById(`p_fio_${i}`),pe=document.getElementById(`p_pos_${i}`);
    if(!fe) continue;
    const fio=fe.value.trim(),pos=pe.value.trim();
    if(!fio||!pos){if(!fio)fe.style.border="1.5px solid red";if(!pos)pe.style.border="1.5px solid red";return null;}
    fe.style.border=pe.style.border="1px solid #ccc";
    list.push({fio,fioGen:declineFullName(fio),position:pos});
  }
  return list.length?list:null;
}

// =============================================
//  GOOGLE SHEETS
// =============================================
async function getNextNumFromSheets(key,f,persons){
  const url=getSheetsUrl();
  if(!url) return null;
  try{
    // –°–Ω–∞—á–∞–ª–∞ GET ‚Äî –ø–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä
    const getResp=await fetch(url,{method:"GET"});
    const getData=await getResp.json();
    if(!getData.num) return null;
    const num=String(getData.num);

    // –ó–∞—Ç–µ–º POST ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É
    await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        object:  f.object,
        date:    fmtLong(f.date),
        fio:     persons.map(p=>p.fio).join("; "),
        subject: templates[key].subject(f),
      })
    });
    return num;
  }catch(e){
    console.error("Sheets error:",e);
    return null;
  }
}

// =============================================
//  –ì–ï–ù–ï–†–ê–¶–ò–Ø
// =============================================
async function generateDoc(){
  const key=document.getElementById("templateSelect").value;
  if(!key){alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏–∫–∞–∑–∞!");return;}
  const f=getBase(key),persons=getPersons();
  if(!f||!persons){alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");return;}

  addSaved(STORAGE_CONTRACTS,f.contract);
  addSaved(STORAGE_OBJECTS,f.object);

  showStatus("‚è≥ –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ Google Sheets...",false);
  const num=await getNextNumFromSheets(key,f,persons);
  if(num){f.num=num;showStatus(`‚úÖ –ù–æ–º–µ—Ä ${num} –∑–∞–ø–∏—Å–∞–Ω –≤ Google Sheets!`,false);}
  else{showStatus("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä. –£–∫–∞–∂–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.",true);return;}

  const tpl=templates[key],pts=tpl.points(f,persons);

  let rows="";
  persons.forEach((p,i)=>{rows+=`<tr><td>${i+1}</td><td>${p.fio}</td><td>${p.position}</td><td></td><td></td></tr>`;});
  const extra=Math.max(15-persons.length,5);
  for(let i=persons.length;i<persons.length+extra;i++){
    rows+=`<tr><td>${i+1}</td><td></td><td></td><td></td><td></td></tr>`;
  }

  document.getElementById("preview").innerHTML=`
    <p class="pr-center pr-bold">–ü–†–ò–ö–ê–ó</p>
    <span class="pr-gap"></span>
    <table class="pr-header-table">
      <tr>
        <td style="width:65%;font-weight:bold">‚Ññ ${f.num}</td>
        <td style="text-align:right;font-weight:bold">${fmtLong(f.date)}</td>
      </tr>
      <tr>
        <td style="width:60%;font-weight:bold;vertical-align:top">${tpl.subject(f)}</td>
        <td style="width:40%"></td>
      </tr>
    </table>
    <span class="pr-gap"></span>
    <p class="pr-justify">${tpl.preamble(f)}</p>
    <span class="pr-gap"></span>
    <p class="pr-bold">–ü–†–ò–ö–ê–ó–´–í–ê–Æ:</p>
    <span class="pr-gap"></span>
    ${pts.map((p,i)=>`<p class="pr-justify">${i+1}. ${p}</p><span class="pr-gap"></span>`).join("")}
    <table class="pr-sign-table">
      <tr>
        <td style="width:50%;text-align:left">${DIRECTOR_POST}</td>
        <td style="text-align:right">${DIRECTOR}</td>
      </tr>
    </table>
    <div class="page-break-label">‚Äî ‚Äî ‚Äî –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ññ 1 (–Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏) ‚Äî ‚Äî ‚Äî</div>
    <p class="pr-center pr-bold">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ññ 1</p>
    <p class="pr-center">${tpl.annexRef(f)}</p>
    <span class="pr-gap"></span>
    <p class="pr-center pr-bold" style="text-decoration:underline">–õ–ò–°–¢ –û–ó–ù–ê–ö–û–ú–õ–ï–ù–ò–Ø</p>
    <span class="pr-gap"></span>
    <table class="pr-annex-table">
      <thead><tr>
        <th style="width:7%">‚Ññ –ø/–ø</th><th style="width:27%">–§–ò–û</th>
        <th style="width:28%">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th style="width:22%">–î–∞—Ç–∞ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è</th>
        <th style="width:16%">–ü–æ–¥–ø–∏—Å—å</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;

  document.getElementById("preview").style.display="block";
  document.getElementById("btnRow").style.display="flex";
  window._lastKey=key; window._lastValues=f; window._lastPersons=persons;
}

// =============================================
//  XML-–£–¢–ò–õ–ò–¢–´
// =============================================
const SP=`<w:spacing w:before="0" w:after="0" w:line="240" w:lineRule="auto"/>`;

function rpr(bold=false,sz=SZ){
  return `<w:rPr>${bold?"<w:b/>":""}<w:rFonts w:ascii="${FONT}" w:hAnsi="${FONT}" w:cs="${FONT}"/><w:sz w:val="${sz}"/><w:szCs w:val="${sz}"/></w:rPr>`;
}
function para(text,opts={}){
  const{bold=false,center=false,right=false,underline=false,sz=SZ}=opts;
  const jc=center?`<w:jc w:val="center"/>`:right?`<w:jc w:val="right"/>`:`<w:jc w:val="both"/>`;
  const u=underline?`<w:u w:val="single"/>`:"";
  const rp=`<w:rPr>${bold?"<w:b/>":""}${u}<w:rFonts w:ascii="${FONT}" w:hAnsi="${FONT}" w:cs="${FONT}"/><w:sz w:val="${sz}"/><w:szCs w:val="${sz}"/></w:rPr>`;
  return `<w:p><w:pPr>${SP}${jc}</w:pPr><w:r>${rp}<w:t xml:space="preserve">${esc(text)}</w:t></w:r></w:p>`;
}
function emptyPara(){return `<w:p><w:pPr>${SP}</w:pPr><w:r>${rpr()}<w:t></w:t></w:r></w:p>`;}
function pageBreak(){return `<w:p><w:r><w:br w:type="page"/></w:r></w:p>`;}

function cell(text,opts={}){
  const{bold=false,sz=SZ,span=1,center=false,right=false,vis=false,bg="",underline=false}=opts;
  const gs=span>1?`<w:gridSpan w:val="${span}"/>`:"";
  const brd=vis
    ?`<w:top w:val="single" w:sz="4" w:color="000000"/><w:left w:val="single" w:sz="4" w:color="000000"/><w:bottom w:val="single" w:sz="4" w:color="000000"/><w:right w:val="single" w:sz="4" w:color="000000"/>`
    :`<w:top w:val="none" w:sz="0" w:color="auto"/><w:left w:val="none" w:sz="0" w:color="auto"/><w:bottom w:val="none" w:sz="0" w:color="auto"/><w:right w:val="none" w:sz="0" w:color="auto"/>`;
  const shd=bg?`<w:shd w:val="clear" w:color="auto" w:fill="${bg}"/>`:"";
  const jc=center?`<w:jc w:val="center"/>`:right?`<w:jc w:val="right"/>`:`<w:jc w:val="left"/>`;
  const u=underline?`<w:u w:val="single"/>`:"";
  const rp=`<w:rPr>${bold?"<w:b/>":""}${u}<w:rFonts w:ascii="${FONT}" w:hAnsi="${FONT}" w:cs="${FONT}"/><w:sz w:val="${sz}"/><w:szCs w:val="${sz}"/></w:rPr>`;
  return `<w:tc><w:tcPr>${gs}<w:tcBorders>${brd}</w:tcBorders>${shd}
    <w:tcMar><w:left w:w="80" w:type="dxa"/><w:right w:w="80" w:type="dxa"/>
             <w:top w:w="40" w:type="dxa"/><w:bottom w:w="40" w:type="dxa"/></w:tcMar>
  </w:tcPr>
  <w:p><w:pPr>${SP}${jc}</w:pPr><w:r>${rp}<w:t xml:space="preserve">${esc(text)}</w:t></w:r></w:p>
  </w:tc>`;
}

function tbl(rows,vis=false){
  const tb=vis
    ?`<w:tblBorders><w:top w:val="single" w:sz="4" w:color="000000"/><w:left w:val="single" w:sz="4" w:color="000000"/><w:bottom w:val="single" w:sz="4" w:color="000000"/><w:right w:val="single" w:sz="4" w:color="000000"/><w:insideH w:val="single" w:sz="4" w:color="000000"/><w:insideV w:val="single" w:sz="4" w:color="000000"/></w:tblBorders>`
    :`<w:tblBorders><w:top w:val="none"/><w:left w:val="none"/><w:bottom w:val="none"/><w:right w:val="none"/><w:insideH w:val="none"/><w:insideV w:val="none"/></w:tblBorders>`;
  return `<w:tbl><w:tblPr><w:tblW w:w="5000" w:type="pct"/><w:tblLayout w:type="fixed"/>${tb}
    <w:tblCellMar><w:left w:w="0" w:type="dxa"/><w:right w:w="0" w:type="dxa"/></w:tblCellMar>
  </w:tblPr>${rows.join("")}</w:tbl>`;
}

// =============================================
//  –°–ë–û–†–ö–ê DOCX
// =============================================
function buildDocXml(key,f,persons){
  const tpl=templates[key],pts=tpl.points(f,persons);
  const headerTbl=tbl([
    `<w:tr>${cell(`‚Ññ ${f.num}`,{bold:true})}${cell(fmtLong(f.date),{bold:true,right:true})}</w:tr>`,
    `<w:tr>
      <w:tc><w:tcPr><w:tcW w:w="3000" w:type="dxa"/>
        <w:tcBorders><w:top w:val="none" w:sz="0" w:color="auto"/><w:left w:val="none" w:sz="0" w:color="auto"/><w:bottom w:val="none" w:sz="0" w:color="auto"/><w:right w:val="none" w:sz="0" w:color="auto"/></w:tcBorders>
        <w:tcMar><w:left w:w="80" w:type="dxa"/><w:right w:w="80" w:type="dxa"/><w:top w:w="40" w:type="dxa"/><w:bottom w:w="40" w:type="dxa"/></w:tcMar>
      </w:tcPr>
      <w:p><w:pPr>${SP}<w:jc w:val="left"/></w:pPr><w:r>${rpr(true,SZ)}<w:t xml:space="preserve">${esc(tpl.subject(f))}</w:t></w:r></w:p></w:tc>
      <w:tc><w:tcPr><w:tcW w:w="2276" w:type="dxa"/>
        <w:tcBorders><w:top w:val="none" w:sz="0" w:color="auto"/><w:left w:val="none" w:sz="0" w:color="auto"/><w:bottom w:val="none" w:sz="0" w:color="auto"/><w:right w:val="none" w:sz="0" w:color="auto"/></w:tcBorders>
      </w:tcPr>
      <w:p><w:pPr>${SP}</w:pPr><w:r>${rpr()}<w:t></w:t></w:r></w:p></w:tc>
    </w:tr>`,
  ]);
  const signTbl=tbl([
    `<w:tr>${cell(DIRECTOR_POST,{bold:true})}${cell(DIRECTOR,{bold:true,right:true})}</w:tr>`,
  ]);
  const heads=["‚Ññ –ø/–ø","–§–ò–û","–î–æ–ª–∂–Ω–æ—Å—Ç—å","–î–∞—Ç–∞ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è","–ü–æ–¥–ø–∏—Å—å"];
  const hRow=`<w:tr>${heads.map(h=>cell(h,{bold:true,sz:SZ_S,vis:true,center:true,bg:"F0F0F0"})).join("")}</w:tr>`;
  const dRows=[];
  persons.forEach((p,i)=>{
    dRows.push(`<w:tr>${cell(String(i+1),{sz:SZ_S,vis:true,center:true})}${cell(p.fio,{sz:SZ_S,vis:true})}${cell(p.position,{sz:SZ_S,vis:true})}${cell(" ",{sz:SZ_S,vis:true})}${cell(" ",{sz:SZ_S,vis:true})}</w:tr>`);
  });
  const extra=Math.max(15-persons.length,5);
  for(let i=persons.length;i<persons.length+extra;i++){
    dRows.push(`<w:tr>${cell(String(i+1),{sz:SZ_S,vis:true,center:true})}${[" "," "," "," "].map(t=>cell(t,{sz:SZ_S,vis:true})).join("")}</w:tr>`);
  }
  const annexTbl=tbl([hRow,...dRows],true);
  const body=[
    para("–ü–†–ò–ö–ê–ó",{bold:true,center:true}),emptyPara(),headerTbl,emptyPara(),
    para(tpl.preamble(f)),emptyPara(),para("–ü–†–ò–ö–ê–ó–´–í–ê–Æ:",{bold:true}),emptyPara(),
    ...pts.flatMap((p,i)=>[para(`${i+1}. ${p}`),emptyPara()]),
    signTbl,pageBreak(),
    para("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ññ 1",{bold:true,center:true}),
    para(tpl.annexRef(f),{center:true}),emptyPara(),
    para("–õ–ò–°–¢ –û–ó–ù–ê–ö–û–ú–õ–ï–ù–ò–Ø",{bold:true,center:true,underline:true}),emptyPara(),
    annexTbl,
  ].join("\n");
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
<w:body>${body}
<w:sectPr><w:pgMar w:top="1134" w:right="850" w:bottom="1134" w:left="1701"/></w:sectPr>
</w:body></w:document>`;
}

async function downloadDocx(){
  const key=window._lastKey,f=window._lastValues,persons=window._lastPersons;
  if(!key||!f||!persons){alert("–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç!");return;}
  if(typeof JSZip==="undefined"){showStatus("‚ùå JSZip –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.",true);return;}
  try{
    const zip=new JSZip();
    zip.file("[Content_Types].xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/></Types>`);
    zip.file("_rels/.rels",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/></Relationships>`);
    zip.file("word/document.xml",buildDocXml(key,f,persons));
    zip.file("word/_rels/document.xml.rels",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`);
    const blob=await zip.generateAsync({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`${templates[key].name} ‚Ññ ${f.num}.docx`; a.click();
    URL.revokeObjectURL(url);
    showStatus("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!",false);
  }catch(e){showStatus("‚ùå –û—à–∏–±–∫–∞: "+e.message,true);console.error(e);}
}

function copyDoc(){
  const el=document.getElementById("preview");
  if(el) navigator.clipboard.writeText(el.innerText).then(()=>alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
}
</script>
</body>
</html>
